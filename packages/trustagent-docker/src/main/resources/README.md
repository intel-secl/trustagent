ISecL v1 Agent Container
========================
This repo is to create an image for ISL v1 Agent container. Below instructions 
help in building and running the contianer on Docker runtime.

Pre-requisites
----------------------

* Install Docker runtime: yum install -y docker
* Start docker service: systemctl start docker
* Install docker-compose: 
    sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose

    More info: https://docs.docker.com/compose/install/#install-compose

Building the container
----------------------

ISecL v1 agent could be built using docker-compose or vanilla docker commands. 
This section explains building the image using docker-compose

* **Directory structure**
    ISL v1 agent container can be built using docker-compose. 
    For building the container, below files and directories are expected 
    in the build(current) directory where the docker-compse.yml is exists. 

    * Dockerfile: Dockerfile that is invoked by docker-compose to buid the image
    * trustagent.env: Environment file for setting up the agent
    * start\_isecl-agent: Entry script for the Docker container
    * yum.repos.d/: Directory containing the repo files to connect to a custom 
                    RHEL repository
    * trustagent-linux-\*-SNAPSHOT.bin: Agent installer binary file

* **Container Environment**
    ISL Agent is built over RHEL 7.4 base container. When creating the container
    image, the agent installer is run such that the static content is unzipped
    and placed in the right locations (ex: /opt/trustagent).

    All setup and provisioning tasks are performed during the image launch

* **Docker build command**

    *Simple Container image build*
    docker-compose build -t islv1-agent

    *Container build behind proxy with custom RHEL repos*
    docker-compose build --build-arg http_proxy=<http_proxy_server> \
        --build-arg https_proxy=<https_proxy_server> \
        --build-arg no_proxy=<repo_and_other_local_servers> \
        iseclv1-agent

Running the container
---------------------

* **Installing Host pre-requisites**
    Please run the trustagent-tboot-tss-tools bin file on the host to install the
    host pre-requisiites (tboot, tss tools).

    TSS tools are not mandatory on the host. TSS tools installation can be skipped
    by setting the env variable SKIP_INSTALL_TSS_TOOLS to "yes".

* **Create volumes**
    All the configuration, logs and non-static content generated by the agent
    is stored as part of the volumes so that the agent container remains 
    stateless. So, the below volumes needs to be created before launching the
    agent container.

    Refer [Docker Volumes](https://docs.docker.com/storage/volumes/) for volume 
    management on Docker

    | Type          | Name                 | Container Path                |
    | ------------- |:--------------------:| -----------------------------:|
    | Volume        | tagent_configuration | /opt/trustagent/configuration |
    | Volume        | tagent_logs          | /opt/trustagent/logs          |


    Volumes would be automatically created by docker-compose. 

    Below are the commands to create the required "Volumes" if native docker 
    commands are used to run the image

    > # Create volume for tagent_configuration
    > docker volume create --label tagent_configuration
    >
    > # Create volume for tagent_logs
    > docker volume create --label tagent_configuration


* **Running ISecLv1 Agent image**

    Running the ISecL v1 agent, below env file is needed with the verification server
    details

    * trustagent.env: ENV file containing configuration needed for trustagent 
                      setup. Below is a sample

        MTWILSON_IP_ADDRESS=<ISecL server IP address>
        MTWILSON_HOSTNAME=<ISecL Server Hostname or IP address if the service is running on a host.>
                          # If running on a container, name it "verification-service"
        MTWILSON_API_USERNAME=<ISecL user name>
        MTWILSON_API_PASSWORD=<ISecL user password>
        TPM_OWNER_SECRET=<OPTIONAL: TPM owner secret>
        CURRENT_IP=<IP of the host on which the agent container is running>
        MTWILSON_TLS_CERT_SHA384=<Verification Service CERT SHA384>
        http_proxy=<proxy server address, if behind a proxy>
        https_proxy=<proxy server address, if behind a proxy>

     A helper script (get_tls_sha384) is provided along with the package. This script
     would retrieve the tls sha384 from the server. Please source the above env file
     before invoking the helper script.

    * **Exposing host OS version on the container** *
    With TrustAgent running in a container, the Host info reported in flovar creation
    and other relevant functionality would only reprot the OS version of the container 
    (i.e., RHEL 7.3). To have the underlying host OS Version and Distro details be
    available to the container, perform the below export the below environment variables
    with the appropriate values

        OS_VERSION=<VERSION OF THE UNDERLYING OS: 7.4, 7.5 etc.)
        OS_DISTRO=<OS DISTRIBUTION: RedHatEnterpriseServer etc.)

    Below are the commands to export the values to the vaiables with the host OS details
    
        OS_VERSION=$(lsb_release -a | grep "^Release:"  | cut -f2)
        OS_DISTRO=$(lsb_release -a | grep "^Distributor ID"  | cut -f2)

    TrustAgent container picks up these environment variables from the host and uses the same
    for the host info when TrustAgent creates Flavors etc.

    NOTE:
    Below are the only allowed values for OS_DISTRO
        * REDHATENTERPRISESERVER
        * Windows
        * VMWare ESXI
    Any other value would make the TrustAgent service unresponsive


    * **Command to run ISecL v1 agent** *
    docker-compose up --remove-orphans --abort-on-container-exit

    `docker ps` should show the iseclv1-agent container running.

    NOTE: To re-instantiate a Container on a TPM cleared host, ensure that the Volumes
    are deleted too. Volumes store/save the container state. So, a TPM cleared host needs
    fresh volumes too.

    `docker-compose down -v` would delete the containers and their corresponding volumes too.

* **Restarting the Container**

    Once the container is down/stopped (docker-compose down), the containers does not need the env files and
    db.password to restart since the setup activities are done during the first launch and the configurations
    are stoed as part of the volumes. 

    Two options to run the containers without the configuration

        1. Comment out all the "secrets" block in docker-compose.yml

        2. Delete all the contents in the env file except the proxy details (if needed).

    After the above, run docker-compose up --remove-orphans to start the containers again
